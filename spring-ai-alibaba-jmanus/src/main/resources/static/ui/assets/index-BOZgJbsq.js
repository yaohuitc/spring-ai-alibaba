var et=Object.defineProperty;var tt=(B,l,o)=>l in B?et(B,l,{enumerable:!0,configurable:!0,writable:!0,value:o}):B[l]=o;var ce=(B,l,o)=>tt(B,typeof l!="symbol"?l+"":l,o);import{d as be,f as Se,g as ue,h as Ce,c as v,o as h,m as ae,u as s,e,b as W,t as i,i as k,p as te,F as pe,j as he,q as Ie,w as ge,v as ve,s as Ze,r as O,l as le,x as ke,a as _e,T as nt,y as st,z as we,n as xe,A as ot,k as at}from"./index-hZ4N4EOB.js";import{I as $,_ as $e}from"./_plugin-vue_export-helper-CE4jOYY7.js";import{s as u,P as Re,u as lt}from"./sidebar-9RaFJoLy.js";import{L as it}from"./index-CkGNDGsH.js";const ct={class:"sidebar-content"},rt={class:"sidebar-content-header"},ut={class:"sidebar-content-title"},dt={class:"tab-switcher"},pt=["disabled"],ht={key:0,class:"tab-content"},gt={class:"new-task-section"},vt={class:"sidebar-content-list"},ft={key:0,class:"loading-state"},mt={key:1,class:"error-state"},_t={key:2,class:"empty-state"},Pt=["onClick"],bt={class:"task-icon"},St={class:"task-details"},Ct={class:"task-title"},kt={class:"task-preview"},$t={class:"task-time"},Et={class:"task-actions"},yt=["title","onClick"],It={key:1,class:"tab-content config-tab"},wt={key:0,class:"config-container"},xt={class:"template-info-header"},Rt={class:"template-info"},Dt={class:"template-id"},Tt={class:"config-section"},At={class:"section-header"},Mt={class:"generator-content"},Nt=["placeholder"],Ut={class:"generator-actions"},Lt=["disabled"],qt=["disabled"],Ft={class:"config-section"},Ot={class:"section-header"},Vt={class:"section-actions"},Wt=["disabled","title"],Bt=["disabled","title"],jt=["disabled"],Ht=["placeholder"],zt={class:"execution-content"},Jt={class:"params-input-group"},Gt={class:"params-input-container"},Xt=["placeholder"],Kt=["title"],Qt={class:"config-section"},Yt={class:"section-header"},Zt={class:"execution-content"},en={class:"params-input-group"},tn={class:"params-help-text"},nn={class:"params-input-container"},sn=["placeholder"],on=["title"],an={class:"api-url-display"},ln={class:"api-url-label"},cn={class:"api-url"},rn={class:"api-url-display"},un={class:"api-url-label"},dn=["disabled"],pn=be({__name:"index",emits:["planExecutionRequested"],setup(B,{expose:l,emit:o}){const{t:d}=Se(),L=["currentPlanId","userRequest","rootPlanId"],p=ue({get(){try{if(!u.jsonContent)return"";const P={...JSON.parse(u.jsonContent)};return L.forEach(b=>{delete P[b]}),JSON.stringify(P,null,2)}catch{return u.jsonContent}},set(c){try{if(!c.trim()){u.jsonContent="";return}const P=JSON.parse(c);let b={};try{b=JSON.parse(u.jsonContent||"{}")}catch{}const Q={...P};L.forEach(H=>{b[H]!==void 0&&(Q[H]=b[H])}),u.jsonContent=JSON.stringify(Q)}catch{u.jsonContent=c}}}),x=o,C=async()=>{try{const c=await u.saveTemplate();c!=null&&c.duplicate?alert(d("sidebar.saveCompleted",{message:c.message,versionCount:c.versionCount})):c!=null&&c.saved?alert(d("sidebar.saveSuccess",{message:c.message,versionCount:c.versionCount})):c!=null&&c.message&&alert(d("sidebar.saveStatus",{message:c.message}))}catch(c){console.error("保存计划修改失败:",c),alert(c.message||d("sidebar.saveFailed"))}},G=async()=>{var c;try{await u.generatePlan(),alert(d("sidebar.generateSuccess",{templateId:((c=u.selectedTemplate)==null?void 0:c.id)??d("sidebar.unknown")}))}catch(P){console.error("生成计划失败:",P),alert(d("sidebar.generateFailed")+": "+P.message)}},R=async()=>{try{await u.updatePlan(),alert(d("sidebar.updateSuccess"))}catch(c){console.error("更新计划失败:",c),alert(d("sidebar.updateFailed")+": "+c.message)}},K=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const c=u.preparePlanExecution();if(!c){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",c),console.log("[Sidebar] Emitting planExecutionRequested event"),x("planExecutionRequested",c),console.log("[Sidebar] Event emitted")}catch(c){console.error("执行计划出错:",c),alert(d("sidebar.executeFailed")+": "+c.message)}finally{u.finishPlanExecution()}},J=c=>{const b=new Date().getTime()-c.getTime(),Q=Math.floor(b/6e4),H=Math.floor(b/36e5),q=Math.floor(b/864e5);return Q<1?d("time.now"):Q<60?d("time.minuteAgo",{count:Q}):H<24?d("time.hourAgo",{count:H}):q<30?d("time.dayAgo",{count:q}):c.toLocaleDateString("zh-CN")},V=(c,P)=>!c||c.length<=P?c:c.substring(0,P)+"...";return Ce(()=>{u.loadPlanTemplateList()}),l({loadPlanTemplateList:u.loadPlanTemplateList,toggleSidebar:u.toggleSidebar,currentPlanTemplateId:u.currentPlanTemplateId}),(c,P)=>(h(),v("div",{class:ae(["sidebar-wrapper",{"sidebar-wrapper-collapsed":s(u).isCollapsed}])},[e("div",ct,[e("div",rt,[e("div",ut,i(c.$t("sidebar.title")),1)]),e("div",dt,[e("button",{class:ae(["tab-button",{active:s(u).currentTab==="list"}]),onClick:P[0]||(P[0]=b=>s(u).switchToTab("list"))},[k(s($),{icon:"carbon:list",width:"16"}),te(" "+i(c.$t("sidebar.templateList")),1)],2),e("button",{class:ae(["tab-button",{active:s(u).currentTab==="config"}]),onClick:P[1]||(P[1]=b=>s(u).switchToTab("config")),disabled:!s(u).selectedTemplate},[k(s($),{icon:"carbon:settings",width:"16"}),te(" "+i(c.$t("sidebar.configuration")),1)],10,pt)]),s(u).currentTab==="list"?(h(),v("div",ht,[e("div",gt,[e("button",{class:"new-task-btn",onClick:P[2]||(P[2]=b=>s(u).createNewTemplate())},[k(s($),{icon:"carbon:add",width:"16"}),te(" "+i(c.$t("sidebar.newPlan"))+" ",1),P[13]||(P[13]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",vt,[s(u).isLoading?(h(),v("div",ft,[k(s($),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,i(c.$t("sidebar.loading")),1)])):s(u).errorMessage?(h(),v("div",mt,[k(s($),{icon:"carbon:warning",width:"20"}),e("span",null,i(s(u).errorMessage),1),e("button",{onClick:P[3]||(P[3]=(...b)=>s(u).loadPlanTemplateList&&s(u).loadPlanTemplateList(...b)),class:"retry-btn"},i(c.$t("sidebar.retry")),1)])):s(u).planTemplateList.length===0?(h(),v("div",_t,[k(s($),{icon:"carbon:document",width:"32"}),e("span",null,i(c.$t("sidebar.noTemplates")),1)])):(h(!0),v(pe,{key:3},he(s(u).sortedTemplates,b=>(h(),v("div",{key:b.id,class:ae(["sidebar-content-list-item",{"sidebar-content-list-item-active":b.id===s(u).currentPlanTemplateId}]),onClick:Q=>s(u).selectTemplate(b)},[e("div",bt,[k(s($),{icon:"carbon:document",width:"20"})]),e("div",St,[e("div",Ct,i(b.title||c.$t("sidebar.unnamedPlan")),1),e("div",kt,i(V(b.description||c.$t("sidebar.noDescription"),40)),1)]),e("div",$t,i(J(new Date(b.updateTime||b.createTime))),1),e("div",Et,[e("button",{class:"delete-task-btn",title:c.$t("sidebar.deleteTemplate"),onClick:Ie(Q=>s(u).deleteTemplate(b),["stop"])},[k(s($),{icon:"carbon:close",width:"16"})],8,yt)])],10,Pt))),128))])])):s(u).currentTab==="config"?(h(),v("div",It,[s(u).selectedTemplate?(h(),v("div",wt,[e("div",xt,[e("div",Rt,[e("h3",null,i(s(u).selectedTemplate.title||c.$t("sidebar.unnamedPlan")),1),e("span",Dt,"ID: "+i(s(u).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:P[4]||(P[4]=b=>s(u).switchToTab("list"))},[k(s($),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Tt,[e("div",At,[k(s($),{icon:"carbon:generate",width:"16"}),e("span",null,i(c.$t("sidebar.planGenerator")),1)]),e("div",Mt,[ge(e("textarea",{"onUpdate:modelValue":P[5]||(P[5]=b=>s(u).generatorPrompt=b),class:"prompt-input",placeholder:c.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Nt),[[ve,s(u).generatorPrompt]]),e("div",Ut,[e("button",{class:"btn btn-primary btn-sm",onClick:G,disabled:s(u).isGenerating||!s(u).generatorPrompt.trim()},[k(s($),{icon:s(u).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ae({spinning:s(u).isGenerating})},null,8,["icon","class"]),te(" "+i(s(u).isGenerating?c.$t("sidebar.generating"):c.$t("sidebar.generatePlan")),1)],8,Lt),e("button",{class:"btn btn-secondary btn-sm",onClick:R,disabled:s(u).isGenerating||!s(u).generatorPrompt.trim()||!s(u).jsonContent.trim()},[k(s($),{icon:"carbon:edit",width:"14"}),te(" "+i(c.$t("sidebar.updatePlan")),1)],8,qt)])])]),e("div",Ft,[e("div",Ot,[k(s($),{icon:"carbon:code",width:"16"}),e("span",null,i(c.$t("sidebar.jsonTemplate")),1),e("div",Vt,[e("button",{class:"btn btn-sm",onClick:P[6]||(P[6]=(...b)=>s(u).rollbackVersion&&s(u).rollbackVersion(...b)),disabled:!s(u).canRollback,title:c.$t("sidebar.rollback")},[k(s($),{icon:"carbon:undo",width:"14"})],8,Wt),e("button",{class:"btn btn-sm",onClick:P[7]||(P[7]=(...b)=>s(u).restoreVersion&&s(u).restoreVersion(...b)),disabled:!s(u).canRestore,title:c.$t("sidebar.restore")},[k(s($),{icon:"carbon:redo",width:"14"})],8,Bt),e("button",{class:"btn btn-primary btn-sm",onClick:C,disabled:s(u).isGenerating||s(u).isExecuting},[k(s($),{icon:"carbon:save",width:"14"})],8,jt)])]),ge(e("textarea",{"onUpdate:modelValue":P[8]||(P[8]=b=>p.value=b),class:"json-editor",placeholder:c.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,Ht),[[ve,p.value]]),e("div",zt,[e("div",Jt,[e("label",null,i(c.$t("sidebar.cron")),1),e("div",Gt,[ge(e("input",{"onUpdate:modelValue":P[9]||(P[9]=b=>s(u).cron=b),class:"params-input",placeholder:c.$t("sidebar.cronPlaceholder")},null,8,Xt),[[ve,s(u).cron]]),e("button",{class:"clear-params-btn",onClick:P[10]||(P[10]=(...b)=>s(u).clearCron&&s(u).clearCron(...b)),title:c.$t("commmon.clear")},[k(s($),{icon:"carbon:close",width:"12"})],8,Kt)])])])]),e("div",Qt,[e("div",Yt,[k(s($),{icon:"carbon:play",width:"16"}),e("span",null,i(c.$t("sidebar.executionController")),1)]),e("div",Zt,[e("div",en,[e("label",null,i(c.$t("sidebar.executionParams")),1),e("div",tn,i(c.$t("sidebar.executionParamsHelp")),1),e("div",nn,[ge(e("input",{"onUpdate:modelValue":P[11]||(P[11]=b=>s(u).executionParams=b),class:"params-input",placeholder:c.$t("sidebar.executionParamsPlaceholder")},null,8,sn),[[ve,s(u).executionParams]]),e("button",{class:"clear-params-btn",onClick:P[12]||(P[12]=(...b)=>s(u).clearExecutionParams&&s(u).clearExecutionParams(...b)),title:c.$t("sidebar.clearParams")},[k(s($),{icon:"carbon:close",width:"12"})],8,on)])]),e("div",an,[e("span",ln,i(c.$t("sidebar.apiUrl"))+":",1),e("code",cn,i(s(u).computedApiUrl),1)]),e("div",rn,[e("span",un,i(c.$t("sidebar.statusApiUrl"))+":",1),P[14]||(P[14]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:K,disabled:s(u).isExecuting||s(u).isGenerating},[k(s($),{icon:s(u).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ae({spinning:s(u).isExecuting})},null,8,["icon","class"]),te(" "+i(s(u).isExecuting?c.$t("sidebar.executing"):c.$t("sidebar.executePlan")),1)],8,dn)])])])):W("",!0)])):W("",!0)])],2))}}),hn=$e(pn,[["__scopeId","data-v-88462b9a"]]);class Te{static async sendMessage(l){const o=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:l})});if(!o.ok)throw new Error(`API request failed: ${o.status}`);return await o.json()}}ce(Te,"BASE_URL","/api/executor");class Ae{static async getDetails(l){try{const o=await fetch(`${this.BASE_URL}/details/${l}`);if(o.status===404)return null;if(!o.ok)throw new Error(`Failed to get detailed information: ${o.status}`);const d=await o.text(),L=JSON.parse(d);return L&&typeof L=="object"&&!L.currentPlanId&&(L.currentPlanId=l),L}catch(o){return console.error("[CommonApiService] Failed to get plan details:",o),null}}static async submitFormInput(l,o){const d=await fetch(`${this.BASE_URL}/submit-input/${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!d.ok){let p;try{p=await d.json()}catch{p={message:`Failed to submit form input: ${d.status}`}}throw new Error(p.message||`Failed to submit form input: ${d.status}`)}const L=d.headers.get("content-type");return L&&L.indexOf("application/json")!==-1?await d.json():{success:!0}}static async getAllPrompts(){try{const l=await fetch(this.BASE_URL);return await(await this.handleResponse(l)).json()}catch(l){throw console.error("Failed to get Prompt list:",l),l}}static async handleResponse(l){if(!l.ok)try{const o=await l.json();throw new Error(o.message||`API request failed: ${l.status}`)}catch{throw new Error(`API request failed: ${l.status} ${l.statusText}`)}return l}}ce(Ae,"BASE_URL","/api/executor");const de=class de{constructor(){ce(this,"POLL_INTERVAL",5e3);ce(this,"state",Ze({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));ce(this,"callbacks",{});ce(this,"planExecutionCache",new Map);ce(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(l){return this.planExecutionCache.get(l)}getCachedUIState(l){return this.uiStateCache.get(l)}setCachedUIState(l,o){this.uiStateCache.set(l,o),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${l}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(l){return this.planExecutionCache.has(l)}setCachedPlanRecord(l,o){this.planExecutionCache.set(l,o),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${l}`)}clearCachedPlanRecord(l){const o=this.planExecutionCache.delete(l);return o&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${l}`),o}clearAllCachedRecords(){const l=this.planExecutionCache.size,o=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${l}, UI States: ${o}`)}static getInstance(){return de.instance||(de.instance=new de),de.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(l){this.callbacks={...this.callbacks,...l},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(l))}async handleUserMessageSendRequested(l){if(this.validateAndPrepareUIForNewRequest(l))try{if(await this.sendUserMessageAndSetPlanId(l),this.state.activePlanId)this.initiatePlanExecutionSequence(l,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(o){console.error("[PlanExecutionManager] Failed to send user message:",o);const d=this.state.activePlanId??"error";this.setCachedUIState(d,{enabled:!0}),this.emitChatInputUpdateState(d),this.state.activePlanId=null}}handlePlanExecutionRequested(l,o){console.log("[PlanExecutionManager] Received plan execution request:",{planId:l,query:o}),l?(this.state.activePlanId=l,this.initiatePlanExecutionSequence(o??"执行计划",l)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(l,o){const d=this.getCachedPlanRecord(l);return d!=null&&d.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${l}`),this.handlePlanExecutionRequested(d.currentPlanId,o),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${l}`),!1)}validateAndPrepareUIForNewRequest(l){if(!l)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const o=this.state.activePlanId??"ui-state";return this.setCachedUIState(o,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(o),!0}async sendUserMessageAndSetPlanId(l){try{const o=await Te.sendMessage(l);if(o!=null&&o.planId)return this.state.activePlanId=o.planId,o;if(o!=null&&o.planTemplateId)return this.state.activePlanId=o.planTemplateId,{...o,planId:o.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",o),new Error("Failed to get valid planId from API response")}catch(o){throw console.error("[PlanExecutionManager] API call failed:",o),o}}initiatePlanExecutionSequence(l,o){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${l}", planId: ${o}`);const d=o;this.emitDialogRoundStart(d),this.startPolling()}handlePlanCompletion(l){this.emitPlanCompleted(l.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Re.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(o){console.log(`Delete plan execution record failed: ${o.message}`)}},5e3)}catch(o){console.log(`Delete plan execution record failed: ${o.message}`)}l.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(l.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const l=await this.getPlanDetails(this.state.activePlanId);if(!l){console.warn("[PlanExecutionManager] No details received from API");return}if(l.rootPlanId&&this.setCachedPlanRecord(l.rootPlanId,l),!l.steps||l.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(l.rootPlanId??""),this.handlePlanCompletion(l);return}this.emitPlanUpdate(l.rootPlanId??""),l.completed&&this.handlePlanCompletion(l)}catch(l){console.error("[PlanExecutionManager] Failed to poll plan status:",l)}finally{this.state.isPolling=!1}}}async getPlanDetails(l){try{const o=await Ae.getDetails(l);return o!=null&&o.rootPlanId&&(this.planExecutionCache.set(o.rootPlanId,o),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${o.rootPlanId}`)),o}catch(o){return console.error("[PlanExecutionManager] Failed to get plan details:",o),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(l){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(l)}emitDialogRoundStart(l){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(l)}emitPlanUpdate(l){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(l)}emitPlanCompleted(l){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(l)}};ce(de,"instance",null);let De=de;const Y=De.getInstance(),gn={class:"right-panel"},vn={class:"preview-header"},fn={class:"preview-tabs"},mn={class:"tab-button active"},_n={class:"preview-content"},Pn={class:"step-details"},bn={key:0,class:"step-info-fixed"},Sn={key:0,class:"agent-info"},Cn={class:"info-item"},kn={class:"label"},$n={class:"value"},En={class:"info-item"},yn={class:"label"},In={class:"value"},wn={class:"info-item"},xn={class:"label"},Rn={class:"value"},Dn={class:"info-item"},Tn={class:"label"},An={class:"value"},Mn={class:"info-item"},Nn={class:"label"},Un={class:"execution-status"},Ln={class:"status-item"},qn={class:"status-text"},Fn={key:0},On={key:0,class:"think-act-steps"},Vn={class:"steps-container"},Wn={class:"step-header"},Bn={class:"step-number"},jn={class:"think-section"},Hn={class:"think-content"},zn={class:"input"},Jn={class:"label"},Gn={class:"output"},Xn={class:"label"},Kn={key:0,class:"action-section"},Qn={class:"action-content"},Yn={class:"tool-info"},Zn={class:"label"},es={class:"value"},ts={class:"input"},ns={class:"label"},ss={class:"output"},os={class:"label"},as={key:0,class:"sub-plan-section"},ls={class:"sub-plan-content"},is={class:"sub-plan-header"},cs={class:"sub-plan-info"},rs={class:"value"},us={key:0,class:"sub-plan-info"},ds={class:"value"},ps={class:"sub-plan-status"},hs={class:"status-text"},gs={key:0,class:"no-steps-message"},vs={key:1,class:"no-execution-message"},fs={class:"step-basic-info"},ms={class:"info-item"},_s={class:"label"},Ps={class:"value"},bs={key:0,class:"info-item"},Ss={class:"value"},Cs={class:"info-item"},ks={class:"no-execution-hint"},$s={key:2,class:"execution-indicator"},Es={class:"execution-text"},ys={key:1,class:"no-selection"},Is=["title"],ws=be({__name:"index",setup(B,{expose:l}){const{t:o}=Se(),d=O(),L=O(),p=O(),x=O(null),C=O(!1),G=O(!0),R=O(!0),K=ue(()=>p.value?p.value.completed?o("rightPanel.status.completed"):p.value.current?o("rightPanel.status.executing"):o("rightPanel.status.waiting"):""),J=f=>{var D;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${f}`),p.value&&x.value){const I=x.value.rootPlanId??L.value;if(I&&I!==f){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${I}, Requested: ${f}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${f}`);const g=Y.getCachedPlanRecord(f);if(!g){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${f}`);return}if(g.steps&&g.steps.length>0){const I=g.steps.length,_=(g.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${_} / ${I}`)}if(p.value&&L.value&&(L.value===f||((D=x.value)==null?void 0:D.rootPlanId)===f)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${f}`),x.value)){const _=x.value,y=c(_.planId,_.rootPlanId,_.subPlanId);y?(P(y,_.stepIndex,_.planId,_.isSubPlan),Z()):console.warn("[RightPanel] Could not find plan record for refresh:",_)}},V=(f,g,D,I,_)=>{console.log("[RightPanel] Step selected:",{planId:f,stepIndex:g,rootPlanId:D,subPlanId:I,subStepIndex:_});const y=!!(D&&I&&_!==void 0);x.value={planId:f,stepIndex:g,isSubPlan:y,...y&&{rootPlanId:D,subPlanId:I,subStepIndex:_}};const X=c(f,D,I);if(!X){console.warn("[RightPanel] Plan data not found:",{planId:f,rootPlanId:D,subPlanId:I}),p.value=null,x.value=null;return}P(X,g,f,y)},c=(f,g,D)=>{var y;if(!g||!D)return Y.getCachedPlanRecord(f)??null;const I=Y.getCachedPlanRecord(f);if(I)return I;const _=Y.getCachedPlanRecord(g);if(!(_!=null&&_.agentExecutionSequence))return null;for(const X of _.agentExecutionSequence)if(X.thinkActSteps){for(const ne of X.thinkActSteps)if(((y=ne.subPlanExecutionRecord)==null?void 0:y.currentPlanId)===D)return ne.subPlanExecutionRecord}return null},P=(f,g,D,I)=>{var S,F,j,re,Ee;if(!f.steps||g>=f.steps.length){p.value=null,x.value=null,console.warn("[RightPanel] Invalid step data:",{planId:D,stepIndex:g,hasSteps:!!f.steps,stepsLength:(S=f.steps)==null?void 0:S.length,message:"Invalid step index"});return}L.value=D;const _=f.steps[g],y=(F=f.agentExecutionSequence)==null?void 0:F[g];console.log("[RightPanel] Step data details:",{planId:D,stepIndex:g,step:_,hasAgentExecutionSequence:!!f.agentExecutionSequence,agentExecutionSequenceLength:(j=f.agentExecutionSequence)==null?void 0:j.length,agentExecution:y,hasThinkActSteps:!!(y!=null&&y.thinkActSteps),thinkActStepsLength:(re=y==null?void 0:y.thinkActSteps)==null?void 0:re.length,isSubPlan:I});const X=(y==null?void 0:y.status)==="FINISHED",ne=!X&&g===f.currentStepIndex&&!f.completed,m={planId:D,index:g,title:typeof _=="string"?_:_.title||_.description||_.name||`${I?"子":""}步骤 ${g+1}`,description:typeof _=="string"?_:_.description||_,completed:X,current:ne};y&&(m.agentExecution=y),p.value=m,console.log("[RightPanel] Step details updated:",{planId:D,stepIndex:g,stepTitle:p.value.title,hasAgentExecution:!!y,hasThinkActSteps:(((Ee=y==null?void 0:y.thinkActSteps)==null?void 0:Ee.length)??0)>0,completed:X,current:ne,planCurrentStep:f.currentStepIndex,planCompleted:f.completed,isSubPlan:I}),y!=null&&y.thinkActSteps&&y.thinkActSteps.forEach((n,t)=>{n.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${t}:`,n.subPlanExecutionRecord)}),setTimeout(()=>{H()},100),Z()},b=(f,g,D,I)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:f,subPlanId:g,stepIndex:D,subStepIndex:I}),V(g,I,f,g,I)},Q=f=>{d.value=f??void 0},H=()=>{if(!d.value)return;const{scrollTop:f,scrollHeight:g,clientHeight:D}=d.value,I=g-f-D<50,_=g>D;G.value=I,C.value=_&&!I,I?R.value=!0:g-f-D>100&&(R.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:f,scrollHeight:g,clientHeight:D,isAtBottom:I,hasScrollableContent:_,showButton:C.value,shouldAutoScroll:R.value})},q=()=>{d.value&&(d.value.scrollTo({top:d.value.scrollHeight,behavior:"smooth"}),le(()=>{R.value=!0,H()}))},Z=()=>{!R.value||!d.value||le(()=>{d.value&&(d.value.scrollTop=d.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},ee=f=>{if(f===null||typeof f>"u"||f==="")return"N/A";try{const g=typeof f=="object"?f:JSON.parse(f);return JSON.stringify(g,null,2)}catch{return String(f)}},Pe=()=>{p.value=null,L.value=void 0,R.value=!0,d.value&&d.value.removeEventListener("scroll",H)},fe=()=>{const f=()=>{const g=d.value;return g?(Q(g),g.addEventListener("scroll",H),R.value=!0,H(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};le(()=>{f()||setTimeout(()=>{f()},100)})};return Ce(()=>{console.log("[RightPanel] Component mounted"),le(()=>{fe()})}),ke(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),x.value=null,Pe()}),l({updateDisplayedPlanProgress:J,handleStepSelected:V,handleSubPlanStepSelected:b}),(f,g)=>{var D,I;return h(),v("div",gn,[e("div",vn,[e("div",fn,[e("button",mn,[k(s($),{icon:"carbon:events"}),te(" "+i(s(o)("rightPanel.stepExecutionDetails")),1)])])]),e("div",_n,[e("div",Pn,[p.value?(h(),v("div",bn,[e("h3",null,i(p.value.title||p.value.description||s(o)("rightPanel.defaultStepTitle",{number:p.value.index+1})),1),p.value.agentExecution?(h(),v("div",Sn,[e("div",Cn,[e("span",kn,i(s(o)("rightPanel.executingAgent"))+":",1),e("span",$n,i(p.value.agentExecution.agentName),1)]),e("div",En,[e("span",yn,i(s(o)("rightPanel.description"))+":",1),e("span",In,i(p.value.agentExecution.agentDescription||""),1)]),e("div",wn,[e("span",xn,i(s(o)("rightPanel.callingModel"))+":",1),e("span",Rn,i(p.value.agentExecution.modelName),1)]),e("div",Dn,[e("span",Tn,i(s(o)("rightPanel.request"))+":",1),e("span",An,i(p.value.agentExecution.agentRequest||""),1)]),e("div",Mn,[e("span",Nn,i(s(o)("rightPanel.executionResult"))+":",1),e("span",{class:ae(["value",{success:p.value.agentExecution.status==="FINISHED"}])},i(p.value.agentExecution.status||s(o)("rightPanel.executing")),3)])])):W("",!0),e("div",Un,[e("div",Ln,[p.value.completed?(h(),_e(s($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):p.value.current?(h(),_e(s($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(h(),_e(s($),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",qn,i(K.value),1)])])])):W("",!0),e("div",{ref_key:"scrollContainer",ref:d,class:"step-details-scroll-container",onScroll:H},[p.value?(h(),v("div",Fn,[(D=p.value.agentExecution)!=null&&D.thinkActSteps&&p.value.agentExecution.thinkActSteps.length>0?(h(),v("div",On,[e("h4",null,i(s(o)("rightPanel.thinkAndActionSteps")),1),e("div",Vn,[(h(!0),v(pe,null,he(p.value.agentExecution.thinkActSteps,(_,y)=>(h(),v("div",{key:y,class:"think-act-step"},[e("div",Wn,[e("span",Bn,"#"+i(y+1),1),e("span",{class:ae(["step-status",_.status])},i(_.status||s(o)("rightPanel.executing")),3)]),e("div",jn,[e("h5",null,[k(s($),{icon:"carbon:thinking"}),te(" "+i(s(o)("rightPanel.thinking")),1)]),e("div",Hn,[e("div",zn,[e("span",Jn,i(s(o)("rightPanel.input"))+":",1),e("pre",null,i(ee(_.thinkInput)),1)]),e("div",Gn,[e("span",Xn,i(s(o)("rightPanel.output"))+":",1),e("pre",null,i(ee(_.thinkOutput)),1)])])]),_.actionNeeded?(h(),v("div",Kn,[e("h5",null,[k(s($),{icon:"carbon:play"}),te(" "+i(s(o)("rightPanel.action")),1)]),e("div",Qn,[(h(!0),v(pe,null,he(_.actToolInfoList,(X,ne)=>(h(),v("div",{key:ne},[e("div",Yn,[e("span",Zn,i(s(o)("rightPanel.tool"))+":",1),e("span",es,i(X.name||""),1)]),e("div",ts,[e("span",ns,i(s(o)("rightPanel.toolParameters"))+":",1),e("pre",null,i(ee(X.parameters)),1)]),e("div",ss,[e("span",os,i(s(o)("rightPanel.executionResult"))+":",1),e("pre",null,i(ee(X.result)),1)])]))),128))]),_.subPlanExecutionRecord?(h(),v("div",as,[e("h5",null,[k(s($),{icon:"carbon:tree-view"}),te(" "+i(s(o)("rightPanel.subPlan")),1)]),e("div",ls,[e("div",is,[e("div",cs,[g[0]||(g[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",rs,i(_.subPlanExecutionRecord.currentPlanId),1)]),_.subPlanExecutionRecord.title?(h(),v("div",us,[g[1]||(g[1]=e("span",{class:"label"},"标题:",-1)),e("span",ds,i(_.subPlanExecutionRecord.title),1)])):W("",!0),e("div",ps,[_.subPlanExecutionRecord.completed?(h(),_e(s($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(h(),_e(s($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",hs,i(_.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):W("",!0)])):W("",!0)]))),128))]),p.value.agentExecution&&!((I=p.value.agentExecution.thinkActSteps)!=null&&I.length)?(h(),v("div",gs,[e("p",null,i(s(o)("rightPanel.noStepDetails")),1)])):p.value.agentExecution?W("",!0):(h(),v("div",vs,[k(s($),{icon:"carbon:information",class:"info-icon"}),e("h4",null,i(s(o)("rightPanel.stepInfo")),1),e("div",fs,[e("div",ms,[e("span",_s,i(s(o)("rightPanel.stepName"))+":",1),e("span",Ps,i(p.value.title||p.value.description||`步骤 ${p.value.index+1}`),1)]),p.value.description?(h(),v("div",bs,[g[2]||(g[2]=e("span",{class:"label"},"描述:",-1)),e("span",Ss,i(p.value.description),1)])):W("",!0),e("div",Cs,[g[3]||(g[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ae(["value",{"status-completed":p.value.completed,"status-current":p.value.current,"status-pending":!p.value.completed&&!p.value.current}])},i(p.value.completed?"已完成":p.value.current?"执行中":"待执行"),3)])]),e("p",ks,i(s(o)("rightPanel.noExecutionInfo")),1)])),p.value.current&&!p.value.completed?(h(),v("div",$s,[g[4]||(g[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Es,[k(s($),{icon:"carbon:in-progress",class:"rotating-icon"}),te(" "+i(s(o)("rightPanel.stepExecuting")),1)])])):W("",!0)])):(h(),v("div",ys,[k(s($),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,i(s(o)("rightPanel.noStepSelected")),1),e("p",null,i(s(o)("rightPanel.selectStepHint")),1)]))])):W("",!0),k(nt,{name:"scroll-button"},{default:st(()=>[C.value?(h(),v("button",{key:0,onClick:q,class:"scroll-to-bottom-btn",title:s(o)("rightPanel.scrollToBottom")},[k(s($),{icon:"carbon:chevron-down"})],8,Is)):W("",!0)]),_:1})],544)])])])}}}),xs=$e(ws,[["__scopeId","data-v-e90596ce"]]);function Rs(){const B=Y,l=ue(()=>B.getActivePlanId()),o=ue(()=>B.getState()),d=ue(()=>o.value.isPolling),L=ue(()=>!!l.value),p=(R,K)=>{B.initiatePlanExecutionSequence(R,K)},x=()=>{B.stopPolling()},C=()=>{B.startPolling()},G=()=>{B.cleanup()};return ke(()=>{G()}),{activePlanId:l,state:o,isPolling:d,hasActivePlan:L,startExecution:p,stopPolling:x,startPolling:C,cleanup:G}}const Ds={class:"chat-container"},Ts={class:"message-content"},As={key:0,class:"user-message"},Ms={key:1,class:"assistant-message"},Ns={key:0,class:"thinking-section"},Us={class:"thinking-header"},Ls={class:"thinking-avatar"},qs={class:"thinking-label"},Fs={class:"thinking-content"},Os={key:0,class:"thinking"},Vs={key:1,class:"progress"},Ws={class:"progress-bar"},Bs={class:"progress-text"},js={key:2,class:"steps-container"},Hs={class:"steps-title"},zs=["onClick"],Js={class:"section-header"},Gs={class:"step-icon"},Xs={class:"step-title"},Ks={key:0,class:"step-status current"},Qs={key:1,class:"step-status completed"},Ys={key:2,class:"step-status pending"},Zs={key:0,class:"action-info"},eo={class:"action-description"},to={class:"action-icon"},no={key:0,class:"tool-params"},so={class:"param-label"},oo={class:"param-content"},ao={key:1,class:"think-details"},lo={class:"think-header"},io={class:"think-label"},co={class:"think-output"},ro={class:"think-content"},uo={key:1,class:"sub-plan-steps"},po={class:"sub-plan-header"},ho={class:"sub-plan-step-list"},go=["onClick"],vo={class:"sub-step-indicator"},fo={class:"sub-step-icon"},mo={class:"sub-step-number"},_o={class:"sub-step-content"},Po={class:"sub-step-title"},bo={key:2,class:"user-input-form-container"},So={class:"user-input-message"},Co={key:0,class:"form-description"},ko=["onSubmit"],$o=["for"],Eo=["id","name","onUpdate:modelValue"],yo={key:1,class:"form-group"},Io={for:"form-input-genericInput"},wo=["onUpdate:modelValue"],xo={type:"submit",class:"submit-user-input-btn"},Ro={key:3,class:"default-processing"},Do={class:"processing-indicator"},To={class:"response-section"},Ao={class:"response-header"},Mo={class:"response-avatar"},No={class:"response-name"},Uo={class:"response-content"},Lo={key:0,class:"final-response"},qo=["innerHTML"],Fo={key:1,class:"response-placeholder"},Oo={class:"typing-indicator"},Vo={class:"typing-text"},Wo={key:0,class:"message assistant"},Bo={class:"message-content"},jo={class:"assistant-message"},Ho={class:"thinking-section"},zo={class:"thinking-header"},Jo={class:"thinking-avatar"},Go={class:"thinking-label"},Xo={class:"thinking-content"},Ko={class:"default-processing"},Qo={class:"processing-indicator"},Yo={class:"response-section"},Zo={class:"response-header"},ea={class:"response-avatar"},ta={class:"response-name"},na={class:"response-content"},sa={class:"response-placeholder"},oa={class:"typing-indicator"},aa={class:"typing-text"},la=["title"],ia=be({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(B,{expose:l,emit:o}){const d=B,L=o,{t:p}=Se(),x=Rs(),C=O(),G=O(!1),R=O([]),K=O(),J=O(!1),V=Ze({}),c=(n,t,a)=>{const r={id:Date.now().toString(),type:n,content:t,timestamp:new Date,...a};return n==="assistant"&&!r.thinking&&!r.content&&(r.thinking=p("chat.thinking")),R.value.push(r),r},P=n=>{const t=R.value[R.value.length-1];t.type==="assistant"&&Object.assign(t,n)},b=async n=>{try{G.value=!0;const t=c("assistant","",{thinking:"正在理解您的请求并准备回复..."}),a=await Te.sendMessage(n);if(a.planId)console.log("[ChatComponent] Received planId from direct execution:",a.planId),t.planExecution||(t.planExecution={}),t.planExecution.currentPlanId=a.planId,Y.handlePlanExecutionRequested(a.planId,n),delete t.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete t.thinking;const r=Q(a,n);t.content=r}}catch(t){console.error("Direct mode error:",t),P({content:H(t)})}finally{G.value=!1}},Q=(n,t)=>n.result??n.message??n.content??"",H=n=>{const t=(n==null?void 0:n.message)??(n==null?void 0:n.toString())??"未知错误";return t.includes("网络")||t.includes("network")||t.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":t.includes("认证")||t.includes("权限")||t.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":t.includes("格式")||t.includes("参数")||t.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${t}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},q=(n=!1)=>{le(()=>{if(C.value){const t=C.value;(n||t.scrollHeight-t.scrollTop-t.clientHeight<150)&&t.scrollTo({top:t.scrollHeight,behavior:n?"auto":"smooth"})}})},Z=()=>{q(!0),J.value=!1},ee=()=>{if(C.value){const n=C.value,t=n.scrollHeight-n.scrollTop-n.clientHeight<150;J.value=!t&&R.value.length>0}},Pe=()=>{C.value&&C.value.addEventListener("scroll",ee)},fe=()=>{C.value&&C.value.removeEventListener("scroll",ee)},f=n=>{c("user",n),d.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",n):b(n)},g=(n,t)=>{var T;const a=((T=n.planExecution)==null?void 0:T.agentExecutionSequence)??[];return t<0||t>=a.length?"IDLE":a[t].status??"IDLE"},D=(n,t)=>{var a,r;if(!((a=n.planExecution)!=null&&a.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:n.planExecution.currentPlanId,stepIndex:t,stepTitle:(r=n.planExecution.steps)==null?void 0:r[t]}),L("step-selected",n.planExecution.currentPlanId,t)},I=(n,t)=>{var a;try{const r=(a=n.planExecution)==null?void 0:a.agentExecutionSequence;if(!(r!=null&&r.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const T=r[t];if(!T)return console.log(`[ChatComponent] No agentExecution found for step ${t}`),[];if(!T.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${t}`),[];for(const w of T.thinkActSteps)if(w.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${t}:`,w.subPlanExecutionRecord),(w.subPlanExecutionRecord.steps??[]).map(A=>typeof A=="string"?A:typeof A=="object"&&A!==null&&(A.title||A.description)||"子步骤");return[]}catch(r){return console.warn("[ChatComponent] Error getting sub-plan steps:",r),[]}},_=(n,t,a)=>{var r;try{const T=(r=n.planExecution)==null?void 0:r.agentExecutionSequence;if(!(T!=null&&T.length))return"pending";const w=T[t];if(!w||!w.thinkActSteps)return"pending";let z=null;for(const M of w.thinkActSteps)if(M.subPlanExecutionRecord){z=M.subPlanExecutionRecord;break}if(!z)return"pending";const A=z.currentStepIndex;return z.completed?"completed":A==null?a===0?"current":"pending":a<A?"completed":a===A?"current":"pending"}catch(T){return console.warn("[ChatComponent] Error getting sub-plan step status:",T),"pending"}},y=(n,t,a)=>{var r,T;try{const w=(r=n.planExecution)==null?void 0:r.agentExecutionSequence;if(!(w!=null&&w.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const z=w[t];if(!z){console.warn("[ChatComponent] No agentExecution found for step",t);return}if(!z.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",t);return}let A=null;for(const M of z.thinkActSteps)if(M.subPlanExecutionRecord){A=M.subPlanExecutionRecord;break}if(!(A!=null&&A.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}L("sub-plan-step-selected",((T=n.planExecution)==null?void 0:T.currentPlanId)??"",A.currentPlanId,t,a)}catch(w){console.error("[ChatComponent] Error handling sub-plan step click:",w)}},X=(n,t)=>{var r,T,w,z;if(!((r=n.planExecution)!=null&&r.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",n.planExecution.steps.length,"execution sequence:",((T=t.agentExecutionSequence)==null?void 0:T.length)??0);const a=new Array(n.planExecution.steps.length).fill(null);if((w=t.agentExecutionSequence)!=null&&w.length){const A=Math.min(t.agentExecutionSequence.length,n.planExecution.steps.length);for(let M=0;M<A;M++){const E=t.agentExecutionSequence[M];if((z=E.thinkActSteps)!=null&&z.length){const N=E.thinkActSteps[E.thinkActSteps.length-1];N.actionDescription&&N.toolParameters?(a[M]={actionDescription:N.actionDescription,toolParameters:typeof N.toolParameters=="string"?N.toolParameters:JSON.stringify(N.toolParameters,null,2),thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:t.currentStepIndex!==void 0&&M<t.currentStepIndex?"completed":t.currentStepIndex!==void 0&&M===t.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${M} action set: ${a[M].actionDescription}`)):(a[M]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:t.currentStepIndex!==void 0&&M===t.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${M} is thinking`))}else a[M]={actionDescription:t.currentStepIndex!==void 0&&M<t.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:t.currentStepIndex!==void 0&&M<t.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${M} 无执行细节, 状态设为: ${a[M].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");n.stepActions=[...a],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(a.map(A=>A==null?void 0:A.actionDescription))),le(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},ne=n=>{console.log("[ChatComponent] Starting dialog round with planId:",n),n&&(R.value.findIndex(a=>{var r;return((r=a.planExecution)==null?void 0:r.currentPlanId)===n&&a.type==="assistant"})===-1?(c("assistant","",{planExecution:{currentPlanId:n},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",n)):console.log("[ChatComponent] Found existing assistant message for planId:",n))},m=n=>{var w,z,A,M;console.log("[ChatComponent] Processing plan update with rootPlanId:",n);const t=Y.getCachedPlanRecord(n);if(!t){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",n);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",t),console.log("[ChatComponent] Plan steps:",t.steps),console.log("[ChatComponent] Plan completed:",t.completed),!t.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const a=R.value.findIndex(E=>{var N;return((N=E.planExecution)==null?void 0:N.currentPlanId)===t.currentPlanId&&E.type==="assistant"});let r;if(a!==-1)r=R.value[a],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",t.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",t.currentPlanId),console.log("[ChatComponent] Current messages:",R.value.map(N=>{var se;return{type:N.type,planId:(se=N.planExecution)==null?void 0:se.currentPlanId,content:N.content.substring(0,50)}}));let E=-1;for(let N=R.value.length-1;N>=0;N--)if(R.value[N].type==="assistant"){E=N;break}if(E!==-1)r=R.value[E],r.planExecution||(r.planExecution={}),r.planExecution.currentPlanId=t.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",t.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(r.planExecution||(r.planExecution={}),r.planExecution=JSON.parse(JSON.stringify(t)),!t.steps||t.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),t.completed){delete r.thinking;const E=t.summary??t.result??t.message??"处理完成";r.content=S(E),console.log("[ChatComponent] Set simple response content:",r.content)}else t.title&&(r.thinking=`正在执行: ${t.title}`);return}delete r.thinking;const T=t.steps.map(E=>typeof E=="string"?E:typeof E=="object"&&E!==null&&(E.title||E.description)||"步骤");if(r.planExecution&&(r.planExecution.steps=T),t.agentExecutionSequence&&t.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",t.agentExecutionSequence.length),X(r,t);const E=t.currentStepIndex??0;if(E>=0&&E<t.agentExecutionSequence.length){const se=t.agentExecutionSequence[E].thinkActSteps;if(se&&se.length>0){const me=se[se.length-1];if(me.thinkOutput){const ye=me.thinkOutput.length>150?me.thinkOutput.substring(0,150)+"...":me.thinkOutput;r.thinking=`正在思考: ${ye}`}}}}else if(r.planExecution){const E=r.planExecution.currentStepIndex??0,N=(w=r.planExecution.steps)==null?void 0:w[E],se=typeof N=="string"?N:"";r.thinking=`正在执行: ${se}`}if(t.userInputWaitState&&r.planExecution?(console.log("[ChatComponent] 需要用户输入:",t.userInputWaitState),r.planExecution.userInputWaitState||(r.planExecution.userInputWaitState={}),r.planExecution.userInputWaitState={message:t.userInputWaitState.message??"",formDescription:t.userInputWaitState.formDescription??"",formInputs:((z=t.userInputWaitState.formInputs)==null?void 0:z.map(E=>({label:E.label,value:E.value||""})))??[]},V[A=r.id]??(V[A]={}),r.thinking="等待用户输入..."):(M=r.planExecution)!=null&&M.userInputWaitState&&delete r.planExecution.userInputWaitState,t.completed??t.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete r.thinking;let E="";t.summary?E=t.summary:t.result?E=t.result:E="任务已完成",r.content=F(E),console.log("[ChatComponent] Updated completed message:",r.content)}le(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},S=n=>n?n.includes("我")||n.includes("您")||n.includes("您好")||n.includes("可以")?n:n.length<10?`${n}！还有什么需要我帮助的吗？`:n.length<50?`好的，${n}。如果您还有其他问题，请随时告诉我。`:`${n}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",F=n=>n?`${n}`:"任务已完成！还有什么我可以帮您的吗？",j=n=>{console.log("[ChatComponent] Plan completed with rootPlanId:",n);const t=Y.getCachedPlanRecord(n);if(!t){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",n);return}if(console.log("[ChatComponent] Plan details:",t),t.rootPlanId){const a=R.value.findIndex(r=>{var T;return((T=r.planExecution)==null?void 0:T.currentPlanId)===t.rootPlanId});if(a!==-1){const r=R.value[a];delete r.thinking;let w=t.summary??t.result??"任务已完成";!w.includes("我")&&!w.includes("您")&&(w.includes("成功")||w.includes("完成")?w=`很好！${w}。如果您还有其他需要帮助的地方，请随时告诉我。`:w=`我已经完成了您的请求：${w}`),r.content=w,console.log("[ChatComponent] Updated completed message:",r.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",t.rootPlanId)}},re=n=>{if(!n)return"";let t=n.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return t=t.replace(/(<br><br>)/g,"</p><p>"),t.includes("</p><p>")&&(t=`<p>${t}</p>`),t},Ee=async n=>{var t;if(!((t=n.planExecution)!=null&&t.currentPlanId)||!n.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const a={},r=n.planExecution.userInputWaitState.formInputs;r&&r.length>0?Object.entries(V[n.id]).forEach(([w,z])=>{var E;const A=parseInt(w,10),M=((E=r[A])==null?void 0:E.label)||`input_${w}`;a[M]=z}):a.genericInput=n.genericInput??"",console.log("[ChatComponent] 提交用户输入:",a);const T=await Ae.submitFormInput(n.planExecution.currentPlanId,a);delete n.planExecution.userInputWaitState,delete n.genericInput,delete V[n.id],x.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",T)}catch(a){console.error("[ChatComponent] 用户输入提交失败:",a),alert(`提交失败: ${(a==null?void 0:a.message)||"未知错误"}`)}};return we(()=>d.initialPrompt,(n,t)=>{console.log("[ChatComponent] initialPrompt changed from:",t,"to:",n),n&&typeof n=="string"&&n.trim()&&n!==t&&(console.log("[ChatComponent] Processing changed initial prompt:",n),le(()=>{f(n)}))},{immediate:!1}),Ce(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),Y.setEventCallbacks({onPlanUpdate:m,onPlanCompleted:j,onDialogRoundStart:ne,onChatInputUpdateState:n=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",n)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),le(()=>{Pe()}),d.initialPrompt&&typeof d.initialPrompt=="string"&&d.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",d.initialPrompt),le(()=>{f(d.initialPrompt)}))}),ke(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),fe(),K.value&&clearInterval(K.value),x.cleanup(),Object.keys(V).forEach(n=>delete V[n])}),l({handleSendMessage:f,handlePlanUpdate:m,handlePlanCompleted:j,handleDialogRoundStart:ne,addMessage:c}),(n,t)=>(h(),v("div",Ds,[e("div",{class:"messages",ref_key:"messagesRef",ref:C},[(h(!0),v(pe,null,he(R.value,a=>{var r,T,w,z,A,M,E,N,se;return h(),v("div",{key:a.id,class:ae(["message",{user:a.type==="user",assistant:a.type==="assistant"}])},[e("div",Ts,[a.type==="user"?(h(),v("div",As,i(a.content),1)):(h(),v("div",Ms,[a.thinking||((r=a.planExecution)==null?void 0:r.progress)!==void 0||(((w=(T=a.planExecution)==null?void 0:T.steps)==null?void 0:w.length)??0)>0?(h(),v("div",Ns,[e("div",Us,[e("div",Ls,[k(s($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",qs,i(n.$t("chat.thinkingLabel")),1)]),e("div",Fs,[a.thinking?(h(),v("div",Os,[k(s($),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,i(a.thinking),1)])):W("",!0),((z=a.planExecution)==null?void 0:z.progress)!==void 0?(h(),v("div",Vs,[e("div",Ws,[e("div",{class:"progress-fill",style:xe({width:a.planExecution.progress+"%"})},null,4)]),e("span",Bs,i(a.planExecution.progressText??n.$t("chat.processing")+"..."),1)])):W("",!0),(((M=(A=a.planExecution)==null?void 0:A.steps)==null?void 0:M.length)??0)>0?(h(),v("div",js,[e("h4",Hs,i(n.$t("chat.stepExecutionDetails")),1),(h(!0),v(pe,null,he((E=a.planExecution)==null?void 0:E.steps,(me,U)=>{var ye,Me,Ne,Ue,Le,qe,Fe,Oe,Ve,We,Be,je,He,ze,Je,Ge,Xe,Ke,Qe;return h(),v("div",{key:U,class:ae(["ai-section",{running:g(a,U)==="RUNNING",completed:g(a,U)==="FINISHED",pending:g(a,U)==="IDLE"}]),onClick:Ie(ie=>D(a,U),["stop"])},[e("div",Js,[e("span",Gs,i(g(a,U)==="FINISHED"?"✓":g(a,U)==="RUNNING"?"▶":"○"),1),e("span",Xs,i(me||`${n.$t("chat.step")} ${U+1}`),1),g(a,U)==="RUNNING"?(h(),v("span",Ks,i(n.$t("chat.status.executing")),1)):g(a,U)==="FINISHED"?(h(),v("span",Qs,i(n.$t("chat.status.completed")),1)):(h(),v("span",Ys,i(n.$t("chat.status.pending")),1))]),a.stepActions&&a.stepActions[U]?(h(),v("div",Zs,[e("div",eo,[e("span",to,i(((ye=a.stepActions[U])==null?void 0:ye.status)==="current"?"🔄":((Me=a.stepActions[U])==null?void 0:Me.status)==="completed"?"✓":"⏳"),1),e("strong",null,i((Ne=a.stepActions[U])==null?void 0:Ne.actionDescription),1)]),(Ue=a.stepActions[U])!=null&&Ue.toolParameters?(h(),v("div",no,[t[0]||(t[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",so,i(n.$t("common.parameters"))+":",1),e("pre",oo,i((Le=a.stepActions[U])==null?void 0:Le.toolParameters),1)])):W("",!0),(qe=a.stepActions[U])!=null&&qe.thinkOutput?(h(),v("div",ao,[e("div",lo,[t[1]||(t[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",io,i(n.$t("chat.thinkingOutput"))+":",1)]),e("div",co,[e("pre",ro,i((Fe=a.stepActions[U])==null?void 0:Fe.thinkOutput),1)])])):W("",!0)])):W("",!0),((Oe=I(a,U))==null?void 0:Oe.length)>0?(h(),v("div",uo,[e("div",po,[k(s($),{icon:"carbon:tree-view",class:"sub-plan-icon"}),t[2]||(t[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",ho,[(h(!0),v(pe,null,he(I(a,U),(ie,oe)=>(h(),v("div",{key:`sub-${U}-${oe}`,class:ae(["sub-plan-step-item",{completed:_(a,U,oe)==="completed",current:_(a,U,oe)==="current",pending:_(a,U,oe)==="pending"}]),onClick:Ie(Ye=>y(a,U,oe),["stop"])},[e("div",vo,[e("span",fo,i(_(a,U,oe)==="completed"?"✓":_(a,U,oe)==="current"?"▶":"○"),1),e("span",mo,i(oe+1),1)]),e("div",_o,[e("span",Po,i(ie),1),t[3]||(t[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,go))),128))])])):W("",!0),(Ve=a.planExecution)!=null&&Ve.userInputWaitState&&g(a,U)==="RUNNING"?(h(),v("div",bo,[e("p",So,i(((Be=(We=a.planExecution)==null?void 0:We.userInputWaitState)==null?void 0:Be.message)??n.$t("chat.userInput.message")),1),(He=(je=a.planExecution)==null?void 0:je.userInputWaitState)!=null&&He.formDescription?(h(),v("p",Co,i((Je=(ze=a.planExecution)==null?void 0:ze.userInputWaitState)==null?void 0:Je.formDescription),1)):W("",!0),e("form",{onSubmit:Ie(ie=>Ee(a),["prevent"]),class:"user-input-form"},[(Xe=(Ge=a.planExecution)==null?void 0:Ge.userInputWaitState)!=null&&Xe.formInputs&&a.planExecution.userInputWaitState.formInputs.length>0?(h(!0),v(pe,{key:0},he((Qe=(Ke=a.planExecution)==null?void 0:Ke.userInputWaitState)==null?void 0:Qe.formInputs,(ie,oe)=>(h(),v("div",{key:oe,class:"form-group"},[e("label",{for:`form-input-${ie.label.replace(/\W+/g,"_")}`},i(ie.label)+": ",9,$o),ge(e("input",{type:"text",id:`form-input-${ie.label.replace(/\W+/g,"_")}`,name:ie.label,"onUpdate:modelValue":Ye=>V[a.id][oe]=Ye,class:"form-input"},null,8,Eo),[[ve,V[a.id][oe]]])]))),128)):(h(),v("div",yo,[e("label",Io,i(n.$t("common.input"))+":",1),ge(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":ie=>a.genericInput=ie,class:"form-input"},null,8,wo),[[ve,a.genericInput]])])),e("button",xo,i(n.$t("chat.userInput.submit")),1)],40,ko)])):W("",!0)],10,zs)}),128))])):!a.content&&(a.thinking||((N=a.planExecution)==null?void 0:N.progress)!==void 0&&(((se=a.planExecution)==null?void 0:se.progress)??0)<100)?(h(),v("div",Ro,[e("div",Do,[t[4]||(t[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,i(a.thinking??n.$t("chat.thinkingProcessing")),1)])])):W("",!0)])])):W("",!0),e("div",To,[e("div",Ao,[e("div",Mo,[k(s($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",No,i(n.$t("chat.botName")),1)]),e("div",Uo,[a.content?(h(),v("div",Lo,[e("div",{class:"response-text",innerHTML:re(a.content)},null,8,qo)])):(h(),v("div",Fo,[e("div",Oo,[t[5]||(t[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Vo,i(n.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),G.value?(h(),v("div",Wo,[e("div",Bo,[e("div",jo,[e("div",Ho,[e("div",zo,[e("div",Jo,[k(s($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Go,i(n.$t("chat.thinkingLabel")),1)]),e("div",Xo,[e("div",Ko,[e("div",Qo,[t[6]||(t[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,i(n.$t("chat.thinking")),1)])])])]),e("div",Yo,[e("div",Zo,[e("div",ea,[k(s($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",ta,i(n.$t("chat.botName")),1)]),e("div",na,[e("div",sa,[e("div",oa,[t[7]||(t[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",aa,i(n.$t("chat.thinkingResponse")),1)])])])])])])])):W("",!0)],512),J.value?(h(),v("div",{key:0,class:"scroll-to-bottom-btn",onClick:Z,title:n.$t("chat.scrollToBottom")},[k(s($),{icon:"carbon:chevron-down"})],8,la)):W("",!0)]))}}),ca=$e(ia,[["__scopeId","data-v-d1fb4f30"]]),ra={class:"input-area"},ua={class:"input-container"},da={class:"attach-btn",title:"附加文件"},pa=["placeholder","disabled"],ha=["title"],ga=["disabled","title"],va=be({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","plan-mode-clicked"],setup(B,{expose:l,emit:o}){const{t:d}=Se(),L=B,p=o,x=O(),C=O(""),G=ue(()=>L.placeholder||d("input.placeholder")),R=O(G.value),K=ue(()=>!!L.disabled),J=()=>{le(()=>{x.value&&(x.value.style.height="auto",x.value.style.height=Math.min(x.value.scrollHeight,120)+"px")})},V=q=>{q.key==="Enter"&&!q.shiftKey&&(q.preventDefault(),c())},c=()=>{if(!C.value.trim()||K.value)return;const q=C.value.trim();p("send",q),b()},P=()=>{p("plan-mode-clicked")},b=()=>{C.value="",J(),p("clear")};return l({clearInput:b,updateState:(q,Z)=>{Z&&(R.value=q?Z:d("input.waiting")),p("update-state",q,Z)},getQuery:()=>C.value.trim(),focus:()=>{var q;return(q=x.value)==null?void 0:q.focus()}}),Ce(()=>{}),ke(()=>{}),(q,Z)=>(h(),v("div",ra,[e("div",ua,[e("button",da,[k(s($),{icon:"carbon:attachment"})]),ge(e("textarea",{"onUpdate:modelValue":Z[0]||(Z[0]=ee=>C.value=ee),ref_key:"inputRef",ref:x,class:"chat-input",placeholder:R.value,disabled:K.value,onKeydown:V,onInput:J},null,40,pa),[[ve,C.value]]),e("button",{class:"plan-mode-btn",title:q.$t("input.planMode"),onClick:P},[k(s($),{icon:"carbon:document"}),te(" "+i(q.$t("input.planMode")),1)],8,ha),e("button",{class:"send-button",disabled:!C.value.trim()||K.value,onClick:c,title:q.$t("input.send")},[k(s($),{icon:"carbon:send-alt"}),te(" "+i(q.$t("input.send")),1)],8,ga)])]))}}),fa=$e(va,[["__scopeId","data-v-c8e17afe"]]),ma={class:"direct-page"},_a={class:"direct-chat"},Pa={class:"chat-header"},ba={class:"header-actions"},Sa=["title"],Ca={class:"chat-content"},ka=["title"],$a=be({__name:"index",setup(B){const l=ot(),o=at(),d=lt(),{t:L}=Se(),p=O(""),x=O(),C=O(),G=O(),R=O(!1),K=O(!1),J=O(null),V=O(50),c=O(!1),P=O(0),b=O(0);Ce(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",d.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",d.hasUnprocessedTask()),Y.setEventCallbacks({onPlanUpdate:S=>{console.log("[Direct] Plan update event received for rootPlanId:",S),ee(S)&&(console.log("[Direct] Processing plan update for current rootPlanId:",S),C.value&&typeof C.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",S),C.value.handlePlanUpdate(S)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),x.value&&typeof x.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",S),x.value.updateDisplayedPlanProgress(S)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:S=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",S),!!ee(S)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",S),C.value&&typeof C.value.handlePlanCompleted=="function"){const F=Y.getCachedPlanRecord(S);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",F),C.value.handlePlanCompleted(F??{planId:S})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");J.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:S=>{console.log("[Direct] Dialog round start event received for rootPlanId:",S),J.value=S,console.log("[Direct] Set currentRootPlanId to:",S),C.value&&typeof C.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",S),C.value.handleDialogRoundStart(S)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),fe()},onChatInputUpdateState:S=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",S),!ee(S,!0))return;const F=Y.getCachedUIState(S);F&&g(F.enabled,F.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),u.loadPlanTemplateList(),d.hasUnprocessedTask()&&d.currentTask?(p.value=d.currentTask.prompt,console.log("[Direct] Setting prompt from store:",p.value),d.markTaskAsProcessed(),console.log("[Direct] Received task from store:",p.value)):(p.value=l.query.prompt||"",console.log("[Direct] Received task from URL:",p.value),console.log("[Direct] No unprocessed task in store"));const m=localStorage.getItem("directPanelWidth");m&&(V.value=parseFloat(m)),console.log("[Direct] Final prompt value:",p.value)}),we(()=>d.currentTask,m=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",m),m&&!m.processed?(p.value=m.prompt,d.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",p.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),we(()=>p.value,(m,S)=>{console.log("[Direct] prompt value changed from:",S,"to:",m)},{immediate:!1}),ke(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),J.value=null,Y.cleanup(),document.removeEventListener("mousemove",H),document.removeEventListener("mouseup",q)});const Q=m=>{c.value=!0,P.value=m.clientX,b.value=V.value,document.addEventListener("mousemove",H),document.addEventListener("mouseup",q),document.body.style.cursor="col-resize",document.body.style.userSelect="none",m.preventDefault()},H=m=>{if(!c.value)return;const S=window.innerWidth,j=(m.clientX-P.value)/S*100;let re=b.value+j;re=Math.max(20,Math.min(80,re)),V.value=re},q=()=>{c.value=!1,document.removeEventListener("mousemove",H),document.removeEventListener("mouseup",q),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",V.value.toString())},Z=()=>{V.value=50,localStorage.setItem("directPanelWidth","50")},ee=(m,S=!1)=>!J.value||m===J.value||S&&(m==="ui-state"||m==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",m,"current:",J.value),!1),Pe=m=>{console.log("[DirectView] Send message from input:",m),C.value&&typeof C.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",m),C.value.handleSendMessage(m)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},fe=()=>{console.log("[DirectView] Input cleared"),G.value&&typeof G.value.clear=="function"&&G.value.clear()},f=()=>{console.log("[DirectView] Input focused")},g=(m,S)=>{console.log("[DirectView] Input state updated:",m,S),K.value=!m},D=(m,S)=>{console.log("[DirectView] Step selected:",m,S),x.value&&typeof x.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",m,S),x.value.handleStepSelected(m,S)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},I=(m,S,F,j)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:m,subPlanId:S,stepIndex:F,subStepIndex:j}),x.value&&typeof x.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:m,subPlanId:S,stepIndex:F,subStepIndex:j}),x.value.handleSubPlanStepSelected(m,S,F,j)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},_=()=>{console.log("[DirectView] Plan mode button clicked"),u.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",u.isCollapsed)},y=()=>{o.push("/home")},X=()=>{o.push("/configs")},ne=async m=>{var S;if(console.log("[DirectView] Plan execution requested:",m),R.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}R.value=!0,C.value&&typeof C.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",m.title),C.value.addMessage("user",m.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const F=m.planData.planTemplateId||m.planData.planId;if(!F)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",F,"params:",m.params),console.log("[Direct] About to call PlanActApiService.executePlan");let j;if((S=m.params)!=null&&S.trim()?(console.log("[Direct] Calling executePlan with params:",m.params.trim()),j=await Re.executePlan(F,m.params.trim())):(console.log("[Direct] Calling executePlan without params"),j=await Re.executePlan(F)),console.log("[Direct] Plan execution API response:",j),j.planId)console.log("[Direct] Got planId from response:",j.planId,"starting plan execution"),J.value=j.planId,console.log("[Direct] Set currentRootPlanId to:",j.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),Y.handlePlanExecutionRequested(j.planId,m.title);else throw console.error("[Direct] No planId in response:",j),new Error("执行计划失败：未返回有效的计划ID")}catch(F){console.error("[Direct] Plan execution failed:",F),console.error("[Direct] Error details:",{message:F.message,stack:F.stack}),J.value=null,C.value&&typeof C.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),C.value.addMessage("user",m.title),C.value.addMessage("assistant",`执行计划失败: ${F.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${F.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),R.value=!1}};return(m,S)=>(h(),v("div",ma,[e("div",_a,[k(hn,{onPlanExecutionRequested:ne}),e("div",{class:"left-panel",style:xe({width:V.value+"%"})},[e("div",Pa,[e("button",{class:"back-button",onClick:y},[k(s($),{icon:"carbon:arrow-left"})]),e("h2",null,i(m.$t("conversation")),1),e("div",ba,[k(it),e("button",{class:"config-button",onClick:X,title:m.$t("direct.configuration")},[k(s($),{icon:"carbon:settings-adjust",width:"20"})],8,Sa)])]),e("div",Ca,[k(ca,{ref_key:"chatRef",ref:C,mode:"direct","initial-prompt":p.value||"",onStepSelected:D,onSubPlanStepSelected:I},null,8,["initial-prompt"])]),(h(),_e(fa,{key:m.$i18n.locale,ref_key:"inputRef",ref:G,disabled:K.value,placeholder:K.value?s(L)("input.waiting"):s(L)("input.placeholder"),onSend:Pe,onClear:fe,onFocus:f,onUpdateState:g,onPlanModeClicked:_},null,8,["disabled","placeholder"]))],4),e("div",{class:"panel-resizer",onMousedown:Q,onDblclick:Z,title:m.$t("direct.panelResizeHint")},S[0]||(S[0]=[e("div",{class:"resizer-line"},null,-1)]),40,ka),k(xs,{ref_key:"rightPanelRef",ref:x,style:xe({width:100-V.value+"%"})},null,8,["style"])])]))}}),Ra=$e($a,[["__scopeId","data-v-e22ae6d7"]]);export{Ra as default};
